import telebot
import requests
from bs4 import BeautifulSoup

TOKEN = '8308377706:AAGLCD2N6QYMeIdfJptvVtZh3ig9WP-aN-c'
bot = telebot.TeleBot(TOKEN)

# نگاشت چند نماد معروف به کد tsetmc شون (شما می‌تونی این لیست رو گسترش بدی)
symbol_map = {
    "فولاد": "42242864443262394",
    "فملی": "35756943739304054",
    "شپنا": "34623325872484384",
    "شتران": "35662074421016060"
}

def get_price(tsetmc_code):
    try:
        url = f"https://www.tsetmc.com/Loader.aspx?ParTree=151311&i={tsetmc_code}"
        response = requests.get(url)
        soup = BeautifulSoup(response.text, "html.parser")

        # سعی می‌کنیم قیمت آخرین معامله رو پیدا کنیم
        price_tag = soup.find("span", {"id": "LastPrice1"})
        if price_tag:
            price_text = price_tag.text.strip()
            return f"{int(price_text):,} ریال"  # قیمت را با کاما جدا کن
        else:
            return "قیمت پیدا نشد."
    except Exception as e:
        return f"خطا در دریافت قیمت: {str(e)}"

@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message, "سلام! نام نماد بورس رو به من بگو، قیمت لحظه‌ای ش رو می‌فرستم.")

@bot.message_handler(func=lambda message: True)
def handle_message(message):
    symbol_name = message.text.strip()
    if symbol_name in symbol_map:
        code = symbol_map[symbol_name]
        price = get_price(code)
        bot.reply_to(message, f"قیمت نماد {symbol_name}: {price}")
    else:
        bot.reply_to(message, "نماد در لیست نیست. لطفا نماد دیگری بفرست.")

bot.polling()